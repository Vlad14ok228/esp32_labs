/*
 * Код для Завдання 2:
 * Зчитування АЦП (фоторезистора) кожні 3 секунди
 * за допомогою одного апаратного таймера.
 */

// Пін, до якого підключений фоторезистор (АЦП)
#define PHOTORESISTOR_PIN 34

// Вказівник на апаратний таймер
hw_timer_t *timer = NULL;

// "Прапорець", який буде встановлюватися перериванням таймера
volatile bool flag_ReadTimer = false;

// ----------------------------------------------------
// Функція переривання для ТАЙМЕРА
void IRAM_ATTR onTimer() {
  // Просто піднімаємо прапорець
  flag_ReadTimer = true;
}
// ----------------------------------------------------

void setup() {
  // ВАЖЛИВО: Переконайтеся, що в моніторі порту обрано 115200
  Serial.begin(115200);
  pinMode(PHOTORESISTOR_PIN, INPUT);

  Serial.println("Налаштування таймера (1 замір кожні 3 секунди)...");

  // --- Налаштування Таймера ---
  
  // 1. Ініціалізуємо таймер з частотою 1 МГц (1,000,000 тіків в секунду)
  // 1 тік = 1 мікросекунда
  timer = timerBegin(1000000); 
  
  // 2. Прив'язуємо функцію-переривання
  timerAttachInterrupt(timer, &onTimer); 
  
  // 3. Встановлюємо спрацювання (3,000,000 тіків = 3 секунди)
  // (таймер, спрацювати на 3_000_000, авто-перезапуск=true, почати знову з 0)
  timerAlarm(timer, 3000000, true, 0); 
}

void loop() {
  
  // --- Обробник для Таймера ---
  if (flag_ReadTimer) {
    flag_ReadTimer = false; // Одразу опускаємо прапорець
    
    // Виконуємо "важку" роботу тут, в головному циклі
    int value = analogRead(PHOTORESISTOR_PIN);
    Serial.print("Таймер спрацював: Значення фоторезистора = ");
    Serial.println(value);
  }

  // Головний цикл вільний!
}